#!groovy

import uk.gov.hmcts.contino.Helm
import uk.gov.hmcts.contino.Kubectl
import uk.gov.hmcts.contino.Subscription


@Library("Infrastructure@feature/RPE-835-publish-microservice-chart-in-pipeline-2")
Subscription subscription = new Subscription(env)

String product = "rpe"
String component = "feature-toggle-api"

node {
  stage('Publish Helm chart') {
    withAksClient(subscription.nonProdName) {
      Kubectl kubectl = new Kubectl(this, subscription.nonProdName, null)
      kubectl.login()

      String chartName = "${product}-${component}"

      Helm helm = new Helm(this, chartName)
      helm.init()
      helm.publishIfNotExists()
    }
  }
}
